@{
    ViewData["Title"] = "Central de Entregas";
}

<div class="container mt-4">

    <h2 class="mb-4">Central de Entregas</h2>

    <!-- FILTROS -->
    <div class="card p-3 shadow-sm">

        <div class="row mb-3">

            <!-- RETIRADA -->
            <div class="col-md-4">
                <label class="form-label">Tipo de Retirada</label>
                <select id="retirada" class="form-select" onchange="trocar(this.value)">
                    <option value="vazio">Selecione</option>
                    <option value="Local">Local</option>
                    <option value="Entrega">Entrega</option>
                </select>
            </div>

            <!-- SITUAÇÃO -->
            <div class="col-md-4">
                <label class="form-label">Situação</label>
                <select id="situacao" class="form-select" disabled>
                    <option value="">Selecione</option>
                </select>
            </div>

            <!-- BOTÃO -->
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100" onclick="buscar()" id="btnBuscar" disabled>
                    Buscar Entregas
                </button>
            </div>

        </div>

    </div>

    <!-- RESULTADOS -->

    <div style="display:none" id="pesquisarBloco">
        <div>
            <input type="Text" placeholder="Insira o nome do Usuario" id="nomeCliente" />
            <button id="Pesquisar" onclick="Pesquisar()">Pesquisar</button>
            <button id="LimparPesquisa" onclick="Limpar()">Limpar navegação</button>
        </div>
    </div>

    <div class="mt-4">
        <h4>Resultados</h4>
        <div id="resultadoEntregas" class="mt-3"></div>
    </div>

</div>


<script>

    // -------------------------------
    // Trocar opções ao mudar retirada
    // -------------------------------
    function trocar(tipo) {

        const select = document.getElementById("situacao");
        const btn = document.getElementById("btnBuscar");

        // Referência do tbody da tabela
       
        if (tipo === "Entrega") {
            document.getElementById("resultadoEntregas").innerHTML = "";
            btn.disabled = false;
            select.disabled = false;

            select.innerHTML = `
                <option value="">Selecione</option>
                <option value="Em andamento">Em andamento</option>
                <option value="A caminho">A caminho</option>
                <option value="Finalizada">Finalizada</option>
            `;
        }
        else if (tipo === "Local") {
            document.getElementById("resultadoEntregas").innerHTML = "";

            btn.disabled = false;
            select.disabled = false;

            select.innerHTML = `
                <option value="">Selecione</option>
                <option value="Em andamento">Em andamento</option>
                <option value="Finalizada">Finalizada</option>
            `;
        }
        else {
            // ✔ tipo vazio: desabilita e limpa opções
            btn.disabled = true;
            select.disabled = true;

            select.innerHTML = `
                <option value="">Selecione</option>
            `;

            // ✔ limpa a tabela se existir
            document.getElementById("resultadoEntregas").innerHTML = "";

        }
    }


    // -------------------------------
    // Buscar resultados via fetch
    // -------------------------------
    async function buscar() {

        var tipoEntrega = document.getElementById("retirada").value;
        var tipoSituacao = document.getElementById("situacao").value;

        if (tipoEntrega === "vazio") {
            alert("Selecione o tipo de retirada!");
            return;
        }

        if (tipoSituacao === "") {
            alert("Selecione a situação!");
            return;
        }

        var rotaBuscar =
            "/sistema/Entrega/BuscarEnderecos?retirada=" +
            encodeURIComponent(tipoEntrega) +
            "&situacao=" +
            encodeURIComponent(tipoSituacao);

        console.log(rotaBuscar);

        const response = await fetch(rotaBuscar);
        const data = await response.json();

        if (!data.sucesso) {
            alert("Erro: " + data.mensagem);
            return;
        }

        montarTabela(data);
    }


    // -------------------------------
    // Montar tabela dinamicamente
    // -------------------------------
    function montarTabela(data) {

        const div = document.getElementById("resultadoEntregas");
          document.getElementById("pesquisarBloco").style.display = "block";

        if (!data.entregas || data.entregas.length === 0) {
            div.innerHTML = `<div class="alert alert-warning">Nenhuma entrega encontrada.</div>`;
            return;
        }

        let retirada = data.retirada;

        // Cabeçalho muda se for Local
        let colunas = `
                <tr>
                    <th>Código</th>
                    <th>Usuário</th>
                    <th>Email</th>
            `;

        if (retirada === "Entrega") {
            colunas += `
                    <th>CEP</th>
                    <th>Número</th>
                    <th>Complemento</th>
                    <th>Tipo Endereço</th>
                `;
        }

        colunas += `
                    <th>Data Inicial</th>
                    <th>Data Final</th>
                    <th>Detalhes do pedido</th>
                </tr>
            `;

        let html = `
                <table class="table table-bordered table-striped">
                    <thead class="table-dark" id="tablehead">
                        ${colunas}
                    </thead>
                 <tbody id="tabelaResultados">
            `;

        for (let i = 0; i < data.entregas.length; i++) {

            let e = data.entregas[i];
            let user = data.usuarios[i];

            let end = (retirada === "Entrega" && data.enderecos && data.enderecos[i])
                ? data.enderecos[i]
                : { cep: "-", numero: "-", complemento: "-", tipoEndereco: "-" };

          
            html += `
                    <tr>
                        <td>${e.codEntrega}</td>
                        <td>${user.nome}</td>
                        <td>${user.email}</td>
                `;

            if (retirada === "Entrega") {
                html += `
                            <td>${end.cep || "-"}</td>
                            <td>${e.numero || "-"}</td>
                            <td>${e.complemento || "-"}</td>
                            <td>${e.tipoEndereco || "-"}</td>
                    `;
            }

            html += `
                        <td>${e.dataInicial ?? "-"}</td>
                        <td>${e.dataFinal.startsWith("0001-01-01") ? "-" : e.dataFinal}</td>
                       
            `;
            
            let botoes = "";
            botoes += `
                    <button class="btn btn-sm btn-info"
                        onclick="detalhes(${e.codEntrega}, '${retirada}', '${end.tipoEndereco ?? ""}')">
                        Ver detalhes
                    </button>
            `;

            if (e.situacao === "Em andamento" && retirada === "Entrega") {
                botoes += `
                <button class="btn btn-sm btn-warning ms-1"
                   onclick="marcarAcaminho(${e.codEntrega})">
                   Iniciar a entrega
                </button>
                `;
            }

            if (e.situacao === "A caminho") {
                botoes += `
                   <button class="btn btn-sm btn-warning ms-1"
                       onclick="Emandamento(${e.codEntrega})">
                       Voltar para andamento
                    </button>

                    <button class="btn btn-sm btn-warning ms-1"
                       onclick="FinalizarEntrega(${e.codEntrega})">
                       FinalizarEntrega
                    </button>
                `;
            }

            if (retirada === "Local" && e.situacao === "Em andamento") {
                botoes += `
                    <button class="btn btn-sm btn-warning ms-1"
                        onclick="FinalizarLocal(${e.codEntrega})">
                        Entrega Retirada
                    </button>
                `;
            }

            html += `
                <td> ${botoes} </td></tr>
            `;



        }
        

        html += `
                    </tbody>
                </table>
            `;

        div.innerHTML = html;
    }

    function detalhes(cod, tipoRetirada, tipoEndereco)
    {
        window.location = `/sistema/Entrega/Detalhes?codEntrega=${cod}&tipoRetirada=${tipoRetirada}&tipoEndereco=${tipoEndereco}`;
    }

    async function marcarAcaminho(codEntrega)
    {
        var response = await fetch("/sistema/Entrega/Acaminho",{
            method:"POST",
            headers: {"Content-Type" : "application/json"},
            body: JSON.stringify({ codEntrega: codEntrega })
        });
        
        var data = await response.json();

        if(data.sucesso)
        {
            window.location.reload();
        }
        else
        {
            alert(data.mensagem ?? "Não foi possivel realizar essa função");
        }
    }

    async function Emandamento(codEntrega) {
        var response = await fetch("/sistema/Entrega/Em_andamento_Entrega", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codEntrega: codEntrega })
        });

        var data = await response.json();

        if (data.sucesso) {
            window.location.reload();
        }
        else {
            alert(data.mensagem ?? "Não foi possivel realizar essa função");
        }
    }

    async function FinalizarEntrega(codEntrega) {
        var response = await fetch("/sistema/Entrega/Finalizar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codEntrega: codEntrega })
        });

        var data = await response.json();

        if (data.sucesso) {
            window.location.reload();
        }
        else {
            alert(data.mensagem ?? "Não foi possivel realizar essa função");
        }
    }

    async function FinalizarLocal(codEntrega) {
        var response = await fetch("/sistema/Entrega/FinalizarLocal", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codEntrega: codEntrega })
        });

        var data = await response.json();

        if (data.sucesso) {
            window.location.reload();
        }
        else {
            alert(data.mensagem ?? "Não foi possivel realizar essa função");
        }
    }

       async function Pesquisar(){

        var tipoEntrega = document.getElementById("retirada").value;
        var tipoSituacao = document.getElementById("situacao").value;
        var nomeCliente = document.getElementById("nomeCliente").value;

        document.getElementById("resultadoEntregas").innerHTML = "";

        if (tipoEntrega === "vazio") {
            alert("Selecione o tipo de retirada!");
            return;
        }

        if (tipoSituacao === "") {
            alert("Selecione a situação!");
            return;
        }

        var rotaBuscar =
            "/sistema/Entrega/BuscarEnderecosPorNome?retirada=" +
            encodeURIComponent(tipoEntrega) +
            "&situacao=" +
            encodeURIComponent(tipoSituacao) +
            "&nomeCliente=" + encodeURIComponent(nomeCliente);

        const response = await fetch(rotaBuscar);
        const data = await response.json();

        if (!data.sucesso) {
            alert("Erro: " + data.mensagem);
            return;
        }

        montarTabela(data);
    }



      async function Limpar(){

        var tipoEntrega = document.getElementById("retirada").value;
        var tipoSituacao = document.getElementById("situacao").value;

        document.getElementById("nomeCliente").value = "";
        document.getElementById("resultadoEntregas").innerHTML = "";

        var rotaBuscar =
            "/sistema/Entrega/BuscarEnderecos?retirada=" +
            encodeURIComponent(tipoEntrega) +
            "&situacao=" +
            encodeURIComponent(tipoSituacao);

        const response = await fetch(rotaBuscar);
        const data = await response.json();

        if (!data.sucesso) {
            alert("Erro: " + data.mensagem);
            return;
        }

        montarTabela(data);
    }

  


</script>
