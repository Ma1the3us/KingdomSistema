@using MeuProjetoMVC.Models
@{
    ViewData["Title"] = "Dados para Entrega";

    string codVenda = Context.Request.Query["codVenda"].ToString();
    string retirada = Context.Request.Query["retirada"].ToString();

    var entrega = ViewBag.Endereco as EnderecoEntrega;
}
<style>
    body {
        background: linear-gradient(to right, #090F17, #0D141D 5%, #0D141D 95%, #090F17);
        color: white;
        font-family: 'Segoe UI', sans-serif;
        padding: 20px;
    }

    h2, h4 {
        font-weight: 800;
        color: white;
        margin-bottom: 20px;
    }

    label {
        font-weight: 600;
        color: #c3c3d6;
        margin-bottom: 5px;
        display: block;
    }

    input.form-control, select.form-control {
        background: #1e1e2e;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 8px 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.35);
        transition: 0.25s;
        width: 100%;
    }

        input.form-control:focus, select.form-control:focus {
            outline: none;
            box-shadow: 0 6px 16px rgba(91, 74, 245, 0.5);
        }

    button.btn {
        font-weight: 700;
        border-radius: 10px;
        padding: 10px 20px;
        cursor: pointer;
        transition: 0.25s;
        box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    button.btn-primary {
        background: linear-gradient(135deg, #5b4af5, #7c43ff);
        color: white;
        border: none;
    }

        button.btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(91, 74, 245, 0.55);
        }

    button.btn-success {
        background: linear-gradient(135deg, #4ff1d5, #1ce0c1);
        color: white;
        border: none;
    }

        button.btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(79, 241, 213, 0.55);
        }

    button.btn-secondary {
        background: #44475a;
        color: white;
        border: none;
    }

        button.btn-secondary:hover {
            background: #5a5f7a;
            transform: translateY(-1px);
        }

    .alert {
        background: #121218;
        border-left: 5px solid #5b4af5;
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .alert-info {
        background: #161820;
        border-left: 5px solid #4ff1d5;
    }

    ul {
        list-style: none;
        padding: 0;
    }

        ul li {
            margin-bottom: 8px;
            color: #c3c3d6;
        }

            ul li p {
                display: inline;
                font-weight: 600;
                margin-left: 5px;
                color: #fff;
            }

    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }

    .col-md-2, .col-md-3, .col-md-4, .col-md-5 {
        flex: 1;
        min-width: 150px;
    }

    #ap {
        display: flex;
        gap: 15px;
    }

    hr {
        border: 1px solid #2a2a3c;
        margin: 25px 0;
    }

</style>
<h2>Dados de Entrega</h2>

<input type="hidden" id="codVenda" value="@codVenda" />
<input type="hidden" id="tipoRetirada" value="@retirada" />

@if (retirada == "Local")
{
    <div class="alert alert-info">
        
        <p>Compra realizada com sucesso, basta ir a loja designinada para receber a compra</p>


        <div class="row" id="destino2">

            <h4>Insira o Receptor da entrega</h4>
            <br />
            <div class="col-md-5">
                <label>Nome Completo</label>
                <input id="nomeDestinatario" class="form-control" />
            </div>

            <div class="col-md-5">
                <label>Email</label>
                <input id="emailDestinatario" class="form-control" />
            </div>

            <button class="btn btn-success mt-3" onclick="salvarDestinatario()">Confirmar Destinatário</button>
        </div>


        <div>
            <ul>
                <li>Local: <p>KingdomGames</p></li>
                <li>Cep: <p>05089-000</p></li>
                <li>Estado: <p>São Paulo</p></li>
                <li>Cidade: <p>São Paulo</p></li>
                <li>Bairro: <p>Vila Leopoldina</p></li>
                <li>Logradouro: <p>Rua Guaipá</p></li>
                <li>Número: <p>678</p></li>
            </ul>
        </div>

        <a href="/Home/Index" class="btn btn-primary">Voltar a página principal</a>

    </div>



}
else
{
    <h4>Endereço de Entrega</h4>

    <div class="row">
        <div class="col-md-3">
            <label>CEP</label>
            <input id="cep" class="form-control" value="@entrega?.Cep" disabled/>
        </div>

        <div class="col-md-5">
            <label>Logradouro</label>
            <input id="logradouro" class="form-control" value="@entrega?.Logradouro" disabled/>
        </div>

        <div class="col-md-4">
            <label>Bairro</label>
            <input id="bairro" class="form-control" value="@entrega?.Bairro" disabled/>
        </div>

        <div class="col-md-4 mt-2">
            <label>Cidade</label>
            <input id="cidade" class="form-control" value="@entrega?.Cidade" disabled/>
        </div>

        <div class="col-md-2 mt-2">
            <label>Estado</label>
            <input id="estado" class="form-control" value="@entrega?.Estado" disabled/>
        </div>

        <div class="col-md-2 mt-2">
            <label>Número</label>
            <input id="numero" class="form-control" />
        </div>

        <div class="col-md-4 mt-2">
            <label>Complemento</label>
            <input id="complemento" class="form-control" />
        </div>

        <div class="col-md-4 mt-3">
            <label>Tipo Endereço</label>
            <select id="tipoEndereco" class="form-control">
                <option value="">Selecione</option>
                <option value="Casa">Casa</option>
                <option value="Apartamento">Apartamento</option>
            </select>
        </div>
    </div>

    <div id="ap" class="row" style="display:none;">
        <div class="col-md-2 mt-3">
            <label>Andar</label>
            <input id="andar" class="form-control" />
        </div>

        <div class="col-md-4 mt-3">
            <label>Nome do Prédio</label>
            <input id="nomePredio" class="form-control" />
        </div>
    </div>

    <button class="btn btn-primary mt-3" onclick="salvarDadosEntrega()">Salvar Endereço</button>
}

<hr />


<div class="row" id="destino" style="display:none;">

    <h4>Destinatário</h4>
    <br/>
    <div class="col-md-5">
        <label>Nome Completo</label>
        <input id="nomeDestinatario" class="form-control" />
    </div>

    <div class="col-md-5">
        <label>Email</label>
        <input id="emailDestinatario" class="form-control" />
    </div>

    <button class="btn btn-success mt-3" onclick="salvarDestinatario()">Confirmar Destinatário</button>
</div>



<hr />

<div id="confirmacao" style="display:none;">
    <p>Seu pedido estará sendo encaminhado!</p>
    <a href="/Home/Index" class="btn btn-primary">Confirmar entrega</a>
</div>

<a href="/Venda" class="btn btn-secondary mt-3">Voltar</a>

<script>

    if(document.getElementById("tipoRetirada").value == "Local")
    {
        document.getElementById("destino").style.display= "none";
    }


    document.getElementById("tipoEndereco").addEventListener("change", function () {
        const ap = document.getElementById("ap");
        ap.style.display = this.value === "Apartamento" ? "block" : "none";
    });

    async function salvarDadosEntrega() {

        const tipo = document.getElementById("tipoRetirada").value;

        if (tipo === "Local") {
            alert("Retirada no local não precisa de endereço.");
            return;
        }

        const dto = {
            endereco: {
                cep: document.getElementById("cep").value,
                logradouro: document.getElementById("logradouro").value,
                bairro: document.getElementById("bairro").value,
                cidade: document.getElementById("cidade").value,
                estado: document.getElementById("estado").value
            },
            entrega: {
                codVenda: document.getElementById("codVenda").value,
                numero: document.getElementById("numero").value,
                complemento: document.getElementById("complemento").value,
                tipoEndereco: document.getElementById("tipoEndereco").value,
                andar: document.getElementById("andar").value,
                nomePredio: document.getElementById("nomePredio").value
            }
        };

        const response = await fetch("/sistema/Entrega/DadosCliente", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dto)
        });

        const json = await response.json();

        if (json.sucesso) {
            alert("Endereço salvo com sucesso!");
            document.getElementById("destino").style.display = "block";
        } else {
            alert("Erro: " + json.mensagem);
        }
    }


    async function salvarDestinatario() {

        const req = {
            codVenda: document.getElementById("codVenda").value,
            nomeDestinatario: document.getElementById("nomeDestinatario").value,
            emailDestinatario: document.getElementById("emailDestinatario").value
        };

        const response = await fetch("/sistema/Entrega/Destinatario", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(req)
        });

        const json = await response.json();

        if (json.sucesso) {
            const tipo = document.getElementById("tipoRetirada").value;
            if(tipo === "Entrega")
            {
                alert("Destinatário salvo!");
                document.getElementById("confirmacao").style.display = "block";
            }
            else{
                alert("Destinatário salvo! Receptor da entrega foi cadastro!");
            }
        } else {
            alert("Erro ao salvar: " + json.mensagem);
        }
    }

</script>