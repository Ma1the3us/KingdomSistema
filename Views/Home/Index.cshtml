@model List<MeuProjetoMVC.Models.Produto>
@{
    ViewData["Title"] = "Início";

    var categorias = ViewBag.produtosCategoria as List<MeuProjetoMVC.Models.CategoriaProdutos>;
    var busca = ViewBag.busca as string;
}
<link href="~/css/vitrine.css" rel="stylesheet" />

<div class="hero-banner">
    <div class="hero-content">
        <h1>Bem-vindo ao Kingdom of Games</h1>
        <p>Os melhores jogos, preços justos e atualizações constantes.</p>
    </div>
</div>

<form method="get" asp-controller="Home" asp-action="Index" class="search-form">
    <input type="text" name="busca" placeholder="Buscar produto..." value="@busca" class="search-input" />
    <button type="submit" class="search-btn">Buscar</button>
</form>

<h2 id="hRec" class="section-title">Lançamentos Recentes</h2>

@if (Model != null && Model.Count > 0)
{
    <div class="featured-carousel">
        <div id="featuredInner">
            @foreach (var produto in Model)
            {
                <div class="featured-item">
                    <div class="featured-left">
                        @if (produto.Imagens != null && produto.Imagens.Length > 0)
                        {
                            <img class="featured-img" src="data:image/jpeg;base64,@(Convert.ToBase64String(produto.Imagens))" />
                        }
                        else
                        {
                            <img class="featured-img" src="~/img/placeholder-game.png" />
                        }
                </div>

                <div class="featured-right">
                    <h2 class="featured-title">@produto.nomeProduto</h2>
                    <span class="featured-price">R$ @produto.Valor</span>

                    <p class="featured-description">
                        @(string.IsNullOrEmpty(produto.Descricao)
                                            ? "Sem descrição."
                                            : produto.Descricao.Length > 250
                                            ? produto.Descricao.Substring(0, 250) + "..."
                                            : produto.Descricao)
                </p>

                        <a asp-controller="Produto"
                           asp-action="Detalhes"
                           asp-route-codProd="@produto.codProd"
                           class="btn btn-primary">
                            Ver Detalhes
                        </a>
                    </div>
                </div>
                }
        </div>
        @if (Model.Count > 1)
        {
            <div class="featured-controls">
                <button id="fPrev">❮</button>
                <button id="fNext">❯</button>
            </div>
        }
    </div>
}
else
{
    <p>Nenhum produto encontrado.</p>
}

@if (categorias != null && categorias.Count > 0 && busca == null)
{
    <h2 class="section-title" style="margin-top:40px;">Produtos por Categoria</h2>

    @foreach (var cat in categorias)
    {
        <div class="categoria-bloco" style="margin-top:40px;">
            <h3>@cat.nomeCategoria</h3>

            <div id="carouselWrapper-@cat.codCat">
                <div id="carouselInner-@cat.codCat">
                    @foreach (var p in cat.Produtos)
                    {
                        <div class="game-card">
                            @if (p.Imagens != null && p.Imagens.Length > 0)
                            {
                                <img class="game-img"
                                     src="data:image/jpeg;base64,@(Convert.ToBase64String(p.Imagens))"
                                     alt="@p.nomeProduto" />
                            }
                            else
                            {
                                <img class="game-img" src="~/img/placeholder-game.png" />
                            }

                            <div class="game-info">
                                <h3>@p.nomeProduto</h3>
                                <span class="price">R$ @p.Valor</span>
                            </div>

                            <a asp-controller="Produto"
                               asp-action="Detalhes"
                               asp-route-codProd="@p.codProd"
                               class="btn-card">
                                Ver Detalhes
                            </a>
                        </div>
                    }
                </div>
            </div>
            @if (Model.Count > 5)
            {
                <div class="carousel-buttons">
                    <button class="btn-prev" data-target="@cat.codCat">❮</button>
                    <button class="btn-next" data-target="@cat.codCat">❯</button>
                </div>
            }

        </div>
    }
}

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const featuredInner = document.getElementById("featuredInner");
        const fNext = document.getElementById("fNext");
        const fPrev = document.getElementById("fPrev");

        if (featuredInner && fNext && fPrev) {
            const featuredItems = featuredInner.children.length;
            let index = 0;
            let autoplay;

            function updateFeatured() {
                featuredInner.style.transform = `translateX(-${index * 100}%)`;
            }

            function startAutoplay() {
                clearInterval(autoplay);
                autoplay = setInterval(() => {
                    index = (index + 1) % featuredItems;
                    updateFeatured();
                }, 5000);
            }

            fNext.onclick = () => {
                index = (index + 1) % featuredItems;
                updateFeatured();
                startAutoplay();
            };

            fPrev.onclick = () => {
                index = (index - 1 + featuredItems) % featuredItems;
                updateFeatured();
                startAutoplay();
            };

            startAutoplay();
        }

        function setupCategoryCarousel(id) {
            const container = document.getElementById("carouselInner-" + id);
            if (!container) return;

            const card = container.querySelector(".game-card");
            const cardWidth = card.offsetWidth + 25;
            let anim = false;

            const btnNext = document.querySelector(`.btn-next[data-target='${id}']`);
            const btnPrev = document.querySelector(`.btn-prev[data-target='${id}']`);

            if (btnNext) {
                btnNext.onclick = () => {
                    if (anim) return;
                    anim = true;
                    container.style.transition = "transform 0.5s ease-in-out";
                    container.style.transform = `translateX(-${cardWidth}px)`;
                    setTimeout(() => {
                        const first = container.children[0];
                        container.appendChild(first);
                        container.style.transition = "none";
                        container.style.transform = "translateX(0)";
                        anim = false;
                    }, 500);
                };
            }

            if (btnPrev) {
                btnPrev.onclick = () => {
                    if (anim) return;
                    anim = true;
                    const last = container.children[container.children.length - 1];
                    container.insertBefore(last, container.firstChild);
                    container.style.transition = "none";
                    container.style.transform = `translateX(-${cardWidth}px)`;
                    setTimeout(() => {
                        container.style.transition = "transform 0.5s ease-in-out";
                        container.style.transform = "translateX(0)";
                        anim = false;
                    }, 20);
                };
            }
        }

        document.querySelectorAll(".btn-next").forEach(btn => {
            setupCategoryCarousel(btn.dataset.target);
        });
    });
</script>

