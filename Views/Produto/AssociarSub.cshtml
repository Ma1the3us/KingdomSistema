@model MeuProjetoMVC.Models.Produto
@{
    var categoria = ViewBag.Categoria as List<MeuProjetoMVC.Models.Categoria>;
    var sub = ViewBag.Sub as List<MeuProjetoMVC.Models.Sub_Categoria>;
    var selecionadas = ViewBag.Selecionadas as List<int>;
}

<link rel="stylesheet" href="~/css/itemsub.css" />

<div class="itemsub-page">

    <div class="page-header">
        <h1 class="title">Associação de Subcategorias</h1>
    </div>

    <div class="content-grid">
        <h2 class="box-title">Informações do Produto</h2>
        <div class="produto-box">
            <div class="produto-info">
                <div><span class="label">Nome:</span> @Model.nomeProduto</div>
                <div><span class="label">Código:</span> @Model.codProd</div>
                <div><span class="label">Categoria Principal:</span> @(categoria?.FirstOrDefault()?.NomeCategoria ?? "-")</div>
            </div>

            <input type="hidden" id="codProdHidden" value="@Model.codProd" />
        </div>
    </div>

    <hr class="divider" />

    <div class="subcat-section">
        <h2 class="box-title">Subcategorias Disponíveis</h2>

        <div class="tags-container">
            @foreach (var item in sub)
            {
                bool marcado = selecionadas.Contains(item.codSub);
                <label class="tag-item @(marcado ? "active" : "")">
                    <input type="checkbox"
                           class="tag-checkbox"
                           name="subSelecionadas"
                           value="@item.codSub"
                           @(marcado ? "checked" : "") />
                    <span class="tag-text">@item.nomeSubcategoria</span>
                </label>
            }
        </div>

        <button id="btnSalvar" class="btn-save">Salvar Alterações</button>
    </div>

</div>

<script>
    document.getElementById("btnSalvar").addEventListener("click", async () => {
        const codProd = document.getElementById("codProdHidden").value;
        const selecionados = [...document.querySelectorAll("input[name='subSelecionadas']:checked")]
            .map(x => parseInt(x.value));

        const payload = {
            codProd: parseInt(codProd),
            subSelecionados: selecionados
        };

        try {
            const resposta = await fetch("/sistema/itemsub/salvar-por-json", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const retorno = await resposta.json();

            if (retorno.sucesso) {
                alert("Salvo com sucesso!");
                window.location.href = "/ProdutoMidia/Index?codProd=" + codProd;
            } else {
                alert("Erro: " + retorno.mensagem);
            }

        } catch (erro) {
            console.error("Erro no fetch", erro);
        }
    });
</script>
