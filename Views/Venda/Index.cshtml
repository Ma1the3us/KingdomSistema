@model List<CartItem>
@{
    ViewData["Title"] = "Finalizar Compra";
    var produtos = ViewBag.ProdutoNome as List<Produto>;
    var vendas = ViewBag.codVenda as List<Venda>;
    var venda = vendas.FirstOrDefault();
    var cartoes = ViewBag.Cartao as List<cartaoCli>;
}

<input type="hidden" id="codVenda" value="@venda.codVenda" />

<h2>Finalização da Compra</h2>

<h4>Itens do Pedido</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Valor</th>
            <th>Subtotal</th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < Model.Count; i++)
        {
            var item = Model[i];
            var prod = produtos[i];

            <tr>
                <td>@prod.nomeProduto</td>
                <td>@item.Quantidade</td>
                <td>R$ @item.Valor</td>
                <td>R$ @(item.Valor * item.Quantidade)</td>
            </tr>
        }
    </tbody>
</table>

<hr />

<h4>Forma de Retirada</h4>

<select id="tipoRetirada" class="form-control" style="max-width:300px;" onchange="toggleCep()">
    <option value="Entrega">Entrega</option>
    <option value="Local">Retirar no Local</option>
</select>

<hr />

<div id="cepBox">
    <h4>CEP para Entrega</h4>
    <input id="cep" class="form-control" placeholder="00000-000" style="max-width:200px;" />
</div>

<hr />

<h4>Forma de Pagamento</h4>
<select id="formaPagamento" class="form-control" style="max-width:300px;" onchange="toggleCartao()">
    <option value="">Selecione...</option>
    <option value="Pix">Pix</option>

    @if (cartoes != null && cartoes.Any())
    {
        <option disabled>──────────── Cartões ────────────</option>

        foreach (var c in cartoes)
        {
            <option value="@c.tipoCart" data-codcart="@c.codCart">
                @c.bandeira - @c.digitos (@c.tipoCart)
            </option>
        }
    }
</select>

<input type="hidden" id="codCart" value="" />

<button class="btn btn-primary mt-2" onclick="salvarPagamento()">Salvar Forma</button>
<div id="msgForma" class="mt-2"></div>

<hr />

<button class="btn btn-success" onclick="concluir()">Concluir Compra</button>

<script>

    function toggleCep() {
        let tipo = document.getElementById("tipoRetirada").value;
        document.getElementById("cepBox").style.display = (tipo === "Local") ? "none" : "block";
    }


    function toggleCartao() {
        const select = document.getElementById("formaPagamento");
        const codCartInput = document.getElementById("codCart");

        const selectedOption = select.options[select.selectedIndex];
        const codCart = selectedOption.getAttribute("data-codcart");

        if (select.value === "Pix") {
            codCartInput.value = "";
        } else if (codCart) {
            codCartInput.value = codCart;
        }
    }


    // ================================
    // SALVAR FORMA DE PAGAMENTO
    // ================================
    async function salvarPagamento() {
        let forma = document.getElementById("formaPagamento").value;
        let codigo = document.getElementById("codCart").value || null;

        if (!forma) {
            alert("Selecione uma forma de pagamento!");
            return;
        }

        const response = await fetch("/sistema/Venda/FormaPagamento", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                forma: forma,
                codigo: codigo ? parseInt(codigo) : null
            })
        });

        const result = await response.json();

        let msgBox = document.getElementById("msgForma");

        if (result.sucesso) {
            msgBox.innerHTML = `<div class="alert alert-success">${result.mensagem}</div>`;
        } else {
            msgBox.innerHTML = `<div class="alert alert-danger">${result.mensagem}</div>`;
        }
    }


    // ================================
    // FINALIZAR COMPRA
    // ================================
    async function concluir() {
        let tipo = document.getElementById("tipoRetirada").value;
        let cep = document.getElementById("cep").value;
        let venda = document.getElementById("codVenda").value;

        if (tipo === "Entrega" && !cep) {
            alert("Digite o CEP para entrega!");
            return;
        }

        const response = await fetch("/sistema/Venda/ConcluirCompra", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                tipoRetirada: tipo,
                cep: cep
            })
        });

        const result = await response.json();

        if (result.sucesso) {
            alert("Compra concluída! Total final: R$ " + result.valorFinal.toFixed(2));
            window.location.href = `/sistema/Entrega/DadosEntrega?codVenda=${venda}&retirada=${tipo}`;
        } else {
            alert("Erro: " + result.mensagem);
        }
    }

</script>
